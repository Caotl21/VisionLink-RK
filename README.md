# VisionLink-RK

**VisionLink-RK** æ˜¯ä¸€ä¸ªä¸“ä¸º **Rockchip RK3588** å¹³å°ï¼ˆå¦‚ Orange Pi 5 Proï¼‰è®¾è®¡çš„é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿè§†é¢‘æ¨æµå¼•æ“ é€‚ç”¨äºæ°´ä¸‹æœºå™¨äººç­‰å¸¦å®½å—é™åœºæ™¯è¿›è¡Œè§†é¢‘æµä¼ è¾“

è¯¥é¡¹ç›®å……åˆ†åˆ©ç”¨äº† Rockchip çš„ç¡¬ä»¶åŠ é€Ÿèƒ½åŠ›ï¼Œå®ç°äº†ä»æ‘„åƒå¤´é‡‡é›†ã€è‰²å½©ç©ºé—´è½¬æ¢ã€H.264 ç¼–ç åˆ°ç½‘ç»œä¼ è¾“çš„å…¨é“¾è·¯ä¼˜åŒ–ã€‚

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

*   **V4L2 é‡‡é›†**ï¼šç›´æ¥æ“ä½œåº•å±‚ Video4Linux2 æ¥å£ï¼Œè·å–åŸå§‹ YUYV å›¾åƒæ•°æ®ã€‚
*   **ç¡¬ä»¶åŠ é€Ÿè½¬æ¢ (RGA)**ï¼šä½¿ç”¨ Rockchip **RGA (2D Graphic Acceleration)** è¿›è¡Œæ ¼å¼è½¬æ¢ï¼ˆYUYV -> NV12ï¼‰å’Œç¼©æ”¾ã€‚
*   **ç¡¬ä»¶ç¼–ç  (MPP)**ï¼šé›†æˆ Rockchip **MPP (Media Process Platform)**ï¼Œå®ç° H.264 ç¡¬ä»¶ç¼–ç ã€‚
*   **UDP ä½å»¶è¿Ÿä¼ è¾“**ï¼šé€šè¿‡åŸå§‹ UDP Socket å‘é€ H.264 ç æµï¼Œæå¤§å‡å°‘ä¼ è¾“å¼€é”€ã€‚

## ğŸ› ï¸ ç¡¬ä»¶ä¸ç¯å¢ƒè¦æ±‚

*   **ç¡¬ä»¶å¹³å°**ï¼šOrange Pi 5 / 5 Pro / 5 Plus (åŸºäº RK3588/RK3588S)
*   **æ“ä½œç³»ç»Ÿ**ï¼šUbuntu 20.04 / 22.04 (Rockchip BSP)
*   **ä¾èµ–åº“**ï¼š
    *   `libv4l-dev`
    *   `librga-dev` (Rockchip RGA)
    *   `librockchip-mpp-dev` (Rockchip MPP)
    *   `opencv` (å¯é€‰ï¼Œç›®å‰ä»…ç”¨äºæµ‹è¯•å„æ¨¡å—æ•ˆæœ<!--  -->)

## ğŸ“‚ é¡¹ç›®ç»“æ„

```text
.
â”œâ”€â”€ CMakeLists.txt                  # CMakeæ–‡ä»¶
â”œâ”€â”€ inc/                            # å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ dma_utils.h                 # DMA Buffer ç®¡ç†
â”‚   â”œâ”€â”€ mpp_encoder.h               # MPP ç¼–ç å°è£…ç±»
â”‚   â””â”€â”€ v4l2_utils.h                # V4L2 æ“ä½œå°è£…
â”œâ”€â”€ src/                            # æºä»£ç 
â”‚   â”œâ”€â”€ main.cpp                    # ä¸»ç¨‹åºå…¥å£ (é‡‡é›†->RGA->MPP->UDP)
â”‚   â”œâ”€â”€ postprocess.cc              # å®˜æ–¹ï¼šåå¤„ç†ç¨‹åº
â”‚   â”œâ”€â”€ yolo_detector.cpp           # ç›®æ ‡æ£€æµ‹å°è£…ç±»
â”‚   â””â”€â”€ mpp_encoder.cpp             # MPP ç¼–ç å®ç°
â”œâ”€â”€ utils/                          # è¾…åŠ©æ–‡ä»¶
â”‚   â”œâ”€â”€ dma_utils.cpp               # å®ç° dma-heap å†…å­˜åˆ†é…
â”‚   â””â”€â”€ v4l2_utils.c                # V4L2 é‡‡é›†å®ç°
â”œâ”€â”€ python_demo/                    # python demo
â”‚   â”œâ”€â”€ yolov5_rknn.py              # rknnçš„python demo
â”‚   â””â”€â”€ yolov5_ROS.py               # rknné›†æˆROS demo
â”œâ”€â”€ model/                          # æ¨¡å‹æ–‡ä»¶
â”‚   â”œâ”€â”€ yolov5s.rknn                # rknnè½¬åŒ–æ¨¡å‹æ–‡ä»¶
â”‚   â””â”€â”€ coco_80_labels_list.txt     # æ¨¡å‹æ ‡ç­¾æ–‡ä»¶
â”œâ”€â”€ .gitignore                      # gitè¾…åŠ©æ–‡ä»¶
â””â”€â”€ README.md                       # è¯´æ˜æ–‡æ¡£
```

## âš™ï¸ ç¼–è¯‘ä¸æ„å»º

ç¡®ä¿ä½ çš„ç³»ç»Ÿç¯å¢ƒå·²å®‰è£…å¿…è¦çš„å¼€å‘åº“ã€‚

```code
# 1. åˆ›å»ºæ„å»ºç›®å½•
mkdir build
cd build

# 2. ç”Ÿæˆ Makefile
cmake ..

# 3. ç¼–è¯‘
make -j4
```

## ğŸš€ è¿è¡ŒæŒ‡å—

### 1. æ¥æ”¶ç«¯é…ç½® (PCç«¯)

åœ¨è¿è¡Œæ¿å­ä¸Šçš„ç¨‹åºå‰ï¼Œè¯·å…ˆåœ¨ PC ç«¯å‡†å¤‡å¥½æ¥æ”¶å·¥å…·ã€‚ä½ å¯ä»¥ä½¿ç”¨ `ffplay` (FFmpeg ç»„ä»¶) æ¥æ’­æ”¾ã€‚

**PCç«¯å‘½ä»¤ (Windows/Linux):**

```bash
# -f h264: æŒ‡å®šæ ¼å¼ä¸º H.264
# -i udp://0.0.0.0:8888: ç›‘å¬æœ¬åœ° 8888 ç«¯å£
# -fflags nobuffer: ç¦ç”¨ç¼“å†²åŒºä»¥é™ä½å»¶è¿Ÿ
# -flags low_delay: ä½å»¶è¿Ÿæ¨¡å¼

ffplay -f h264 udp://0.0.0.0:8888     -fflags nobuffer     -flags low_delay     -framedrop     -strict experimental     -probesize 32     -analyzeduration 0     -sync ext

```

### 2. å‘é€ç«¯é…ç½® (Orange Pi)

ä¿®æ”¹ `src/main.cpp` ä¸­çš„ç›®æ ‡ IPï¼Œå°†å…¶æŒ‡å‘ä½ çš„ PCï¼š

```cpp
#define DEST_IP   "192.168.13.xxx" // <--- ä¿®æ”¹ä¸ºä½  PC çš„ IP åœ°å€
#define DEST_PORT 8888            // <--- ç¡®ä¿æ²¡æœ‰è¢«é˜²ç«å¢™æ‹¦æˆª
```

### 3. å¼€å§‹æ¨æµ

åœ¨æ¿å­ä¸Šæ‰§è¡Œç¼–è¯‘å¥½çš„ç¨‹åºï¼š

```bash
cd build
sudo ./bricsbot_vision
```

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ åº”è¯¥èƒ½åœ¨ PC ä¸Šçœ‹åˆ°æ¥è‡ªæ‘„åƒå¤´çš„å®æ—¶ç”»é¢ï¼Œä¸”å»¶è¿Ÿæä½ã€‚

## ğŸ“ å…³é”®å‚æ•°è¯´æ˜

åœ¨ `src/main.cpp` ä¸­å¯ä»¥è°ƒæ•´ä»¥ä¸‹å®å®šä¹‰ï¼š

*   `DST_WIDTH` / `DST_HEIGHT`: RGA è¾“å‡ºå’Œ MPP ç¼–ç çš„åˆ†è¾¨ç‡ï¼ˆé»˜è®¤ 640x640ï¼‰ã€‚
*   `UDP_MTU`: UDP åˆ†åŒ…å¤§å°ï¼ˆé»˜è®¤ 1024ï¼‰ï¼Œå»ºè®®å°äº MTU 1500ã€‚

åœ¨ `src/mpp_encoder.cpp` ä¸­å¯ä»¥è°ƒæ•´ç¼–ç å‚æ•°ï¼š

*   `bps` (Bitrate): ç›®æ ‡ç ç‡ï¼Œå½“å‰è®¾ç½®ä¸º 2Mbps ~ 3Mbpsã€‚
*   `rc:mode`: ç ç‡æ§åˆ¶æ¨¡å¼ (CBR å›ºå®šç ç‡)ã€‚

## âš ï¸ å¸¸è§é—®é¢˜æ’æŸ¥

1.  **PC ç«¯æ”¶ä¸åˆ°ç”»é¢**ï¼š
    *   æ£€æŸ¥ PC çš„é˜²ç«å¢™æ˜¯å¦å…è®¸ UDP 8888 ç«¯å£ã€‚
    *   æ£€æŸ¥ `main.cpp` ä¸­çš„ `DEST_IP` æ˜¯å¦å¡«å†™æ­£ç¡®ã€‚
    *   ç¡®ä¿ PC å’Œå¼€å‘æ¿åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘ç½‘æ®µã€‚

2.  **ç”»é¢ç»¿å±æˆ–èŠ±å±**ï¼š
    *   æ£€æŸ¥ MPP çš„ stride (è·¨è·) è®¾ç½®ã€‚RK3588 é€šå¸¸è¦æ±‚å®½å’Œé«˜å¯¹é½åˆ° 16 æˆ– 32ã€‚
    *   æ£€æŸ¥ RGA è½¬æ¢æ—¶çš„æ ¼å¼æ˜¯å¦è®¾ç½®ä¸º `RK_FORMAT_YCbCr_420_SP` (å³ NV12)ã€‚

3.  **Permission Denied (æƒé™é”™è¯¯)**ï¼š
    *   æ“ä½œ `/dev/video0` å’Œ `/dev/dma_heap` é€šå¸¸éœ€è¦ root æƒé™ï¼Œè¯·ä½¿ç”¨ `sudo` è¿è¡Œã€‚